version: 2.1 # use CircleCI 2.1
jobs: # a collection of steps
   build: # runs not using Workflows must have a `build` job as entry point
   
      docker: # run the steps with Docker
      -  image: circleci/openjdk:8-jdk-stretch-browsers # ...with this image as the primary container; this is where all `steps` will run
      
      working_directory: ~/working-dir # directory where steps will run
      
      steps: # a collection of executable commands
      
      - checkout # check out source code to working directory
      
      -  restore_cache: # restore the saved cache after the first run or if `pom.xml` has changed
            key: working-dir-{{ checksum "pom.xml" }}
            
      -  run: mvn dependency:go-offline # gets the project dependencies
      
      -  save_cache: # saves the project dependencies
            paths:
            - ~/.m2
            key: working-dir-{{ checksum "pom.xml" }}
            
      -  run:
           name: Install latest version of ChromeDriver Sample
           command: |
               sudo wget https://chromedriver.storage.googleapis.com/80.0.3987.106/chromedriver_linux64.zip
               sudo unzip chromedriver_linux64.zip
               sudo rm chromedriver_linux64.zip
               sudo mv chromedriver /usr/local/bin/
               sudo chmod 777 /usr/local/bin/chromedriver
           
      - run:
          name: Check out environment variable for profile
          command:
               echo $WIKI_MAVEN_TEST_PROFILE
      - run:
          name: Run Maven Tests
          command: mvn test -P${WIKI_MAVEN_TEST_PROFILE} # run the actual tests
          
      - run:
          name: Save test results
          command: |
            mkdir -p ~/test-results/junit/
            find . -type f -regex ".*/target/surefire-reports/.*xml" -exec cp {} ~/test-results/junit/ \;
          when: always
          
      - store_test_results:
          path: ~/test-results
          
      - store_artifacts:
          path: ~/test-results/junit 
             
      - store_artifacts: # uploads the log files
            path: logs
